#!/bin/sh

sep=';'
hostname="$(hostname)"
d="$(date +'%d-%m-%Y')"
income="0"

calc() {
	res="$(awk -F "$sep" '{sum += $1} END {print sum}')"
	printf "%f" $res
}

find "$HOME"/work/profiles/*/"$hostname" -name 'times' | 
{
	while IFS= read -r file; do
		profile="${file%%/"$hostname/times"}"
		minutes="$(grep 2>/dev/null "$d" "$file" | calc)"
		lock="$HOME/work/profiles/${profile##*/}/$hostname/lock"

		[ -f "$HOME/work/profiles/${profile##*/}/$hostname/rate" ] && hour_rate="$(cat "$HOME/work/profiles/${profile##*/}/$hostname/rate")" || hour_rate="0"
		minute_rate="$(echo "scale=2;$hour_rate/60" | bc)"
		
		if [ -f "$lock" ]; then
			start=$(sed '2q;d' "$lock")
			end=$(date +%s)
			pending="$(echo "scale=2;($end - $start) / 60" | bc)"
			minutes="$(echo "scale=2;$minutes + $pending" | bc)"
			working_time="$(date -u -d @"$((end-start))" +'%-Hh %-Mm')"

			printf "⎾%s %s⏌ " "${profile##*/}" "$working_time"
		fi
		
		income="$(echo "scale=2;$income + $minutes * $minute_rate" | bc)"
	done

	[ "$income" != "0" ] && printf "⎾%.2fPLN today⏌ " "$income"
}

printf "\n"