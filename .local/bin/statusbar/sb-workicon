#!/bin/sh

profiles="${XDG_DATA_HOME:-"$HOME/.local/share"}/profiles" 
sep=';'
hostname="$(hostname)"
d="$(date +'%d-%m-%Y')"
income="0"

calc() {
	res="$(awk -F "$sep" '{sum += $1} END {print sum}')"
	printf "%f" $res
}

find "$profiles" -type d -path "*/$hostname*" | 
{
	while IFS= read -r profile; do
		file="$profile/times"
		lock="$profile/lock"
		rate="$profile/rate"
		minutes="$(grep 2>/dev/null "$d" "$file" | calc)"

		[ -f "$rate" ] && hour_rate="$(cat "$rate")" || hour_rate="0"
		minute_rate="$(echo "scale=2;$hour_rate/60" | bc)"
		
		if [ -f "$lock" ]; then
			start=$(sed '2q;d' "$lock")
			end=$(date +%s)
			pending="$(echo "scale=2;($end - $start) / 60" | bc)"
			minutes="$(echo "scale=2;$minutes + $pending" | bc)"
			working_time="$(date -u -d @"$((end-start))" +'%-Hh %-Mm')"

			printf "⎾%s %s⏌ " "$(echo "${profile%%/$hostname}" | sed "s#${profiles}/_##" | sed 's#/_#/#')" "$working_time"
		fi
		
		income="$(echo "scale=2;$income + $minutes * $minute_rate" | bc)"
	done

	[ "$income" != "0" ] && printf "⎾%.2fPLN today⏌ " "$income"
}

printf "\n"